<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>Cellular acoustics</title>
    <link href="assets/vendor/normalize.css" rel="stylesheet">
    <link href="assets/main.css" rel="stylesheet">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>

<body>
    <header>
        <h1>Cyto-Acoustics</h1>
    </header>
    <a href="https://github.com/lourds-n-cie/cyto-acoustics"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67"
            alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>
    <div class="container">
        <div class="col col1-3">
            <form autocomplete="off" method="GET">
                <section>
                    <h3>Grid</h3>
                    <button id="randomize" type="button"><i>&#x27f3;</i> Generate new random grid</button>
                    <button id="clear" type="button">Clear</button>
                    <div class="modeControl">
                        <div class="onoffswitch">
                            <input type="checkbox" name="playAllNotes" class="onoffswitch-checkbox" id="playAllNotesToggle">
                            <label class="onoffswitch-label" for="playAllNotesToggle">
                                <span class="onoffswitch-inner"></span>
                                <span class="onoffswitch-switch"></span>
                            </label>
                        </div>
                        <small id="hintModeDiff"><em>Play only sound of new cells</em></small>
                        <small id="hintModeFull" style="display:none;"><em>Play sound for all cells</em></small>
                    </div>
                    <label for "gridSizeSelector">Size : </label>
                    <select id="gridSizeSelector" name="gridSize">
                        <option value="8">8 &times; 8</option>
                        <option value="16">16 &times; 16</option>
                        <option value="24">24 &times; 24 (default)</option>
                        <option value="32">32 &times; 32</option>
                        <option value="48">48 &times; 48 (slow)</option>
                        <option value="64">64 &times; 64 (dead slow)</option>
                    </select>
                </section>
                <section>
                    <h3>Iterations</h3>
                    <div class="controller">
                        Auto : <button id="play" type="button">&#x23f5;/&#x23f8;</button><em><small id="iterationStatus">(Paused)</small></em><br/>
                        Step-by-step : <button id="nextStep" type="button">&#x23ed;</button>
                    </div>
                </section>
                <section >
                    <h3>Theremin</h4>
                    <div class="onoffswitch">
                        <input type="checkbox" name="thereminswitch" class="onoffswitch-checkbox" id="thereminswitch">
                        <label class="onoffswitch-label" for="thereminswitch">
                            <span class="onoffswitch-inner"></span>
                            <span class="onoffswitch-switch"></span>
                        </label>
                    </div>
                    <small id="hintThereminOff">Moving the mouse has no effect on the sound</small>
                    <small id="hintThereminOn" style="display:none;">Move the mouse to modulate the sounds</small>
                </section>
                <section class="brush">
                    <h3>Patterns</h3>
                    <small><em>What will be drawn on the grid when you click</em></small>
                    <div class="radio-group">
                        <h4>Cells</h4>
                        <label class="pattern-selector"><input type="radio" name="brush" value="None" checked>Single cell <small>(default)</small></label>
                    </div>
                    <div class="radio-group">
                        <h4>Gliders</h4>
                        <label class="pattern-selector"><input type="radio" name="brush" value="Glider UP">Up &uarr;</label>
                        <label class="pattern-selector"><input type="radio" name="brush" value="Glider RIGHT">Right &rarr;</label>
                        <label class="pattern-selector"><input type="radio" name="brush" value="Glider DOWN">Down &darr;</label>
                        <label class="pattern-selector"><input type="radio" name="brush" value="Glider LEFT">Left &larr;</label>
                    </div>
                    <div class="radio-group">
                        <h4>Guns</h4>
                        <label class="pattern-selector"><input type="radio" name="brush" value="Gun UP">Up &uarr;</label>
                        <label class="pattern-selector"><input type="radio" name="brush" value="Gun RIGHT">Right &rarr;</label>
                        <label class="pattern-selector"><input type="radio" name="brush" value="Gun DOWN">Down &darr;</label>
                        <label class="pattern-selector"><input type="radio" name="brush" value="Gun LEFT">Left &larr;</label>
                    </div>
                </section>
            </form>
        </div>
        <div class="col col2-3">
            <div id="matrix" class="matrix">Loading ...</div>
        </div>
    </div>
    <script type="text/javascript" src="target/cyto-acoustics.js"></script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
        var matrix = document.getElementById('matrix');
        // remove loading message
        matrix.innerHTML = '';
        var gridSize = Number.parseInt(getParameterByName('gridSize'), 10) || 24;
        
        var gridSizeSelector = document.getElementById('gridSizeSelector');
        gridSizeSelector.value = gridSize.toString();
        gridSizeSelector.addEventListener('change', function(){
           this.form.submit();
        });

        var app = Elm.Cytoacoustics.embed(matrix, gridSize);

        // Randomize action
        document.getElementById('randomize').addEventListener("click", function() {
            app.ports.randomize.send(0);
        });

        // Clear action
        document.getElementById('clear').addEventListener("click", function() {
            app.ports.clear.send(0);
        });

        // diff vs. full play
        var playAllNotesToggle = document.getElementById('playAllNotesToggle');
        playAllNotesToggle.addEventListener("click", function() {
            var fullHint = document.getElementById('hintModeFull');
            var diffHint = document.getElementById('hintModeDiff');
            if (playAllNotesToggle.checked) {
                app.ports.switchMode.send("Full");
                fullHint.style.display = 'inline';
                diffHint.style.display = 'none';
            } else {
                app.ports.switchMode.send("Diff");
                fullHint.style.display = 'none';
                diffHint.style.display = 'inline';
            }
        });

        // theremin mode
        var thereminSwitch = document.getElementById('thereminswitch');
        thereminSwitch.addEventListener("click", function() {
            var onHint = document.getElementById('hintThereminOn');
            var offHint = document.getElementById('hintThereminOff');
            if (thereminSwitch.checked) {
                onHint.style.display = 'inline';
                offHint.style.display = 'none';
            } else {
                onHint.style.display = 'none';
                offHint.style.display = 'inline';
            }
            app.ports.toggleTheremin.send("");
        });


        //next generation -- START
        var nextStepButton = document.getElementById('nextStep');
        nextStepButton.addEventListener("click", function() {
            app.ports.nextStep.send("");
        });

        document.getElementById('play').addEventListener("click", function() {
            var statusIndicator = document.getElementById('iterationStatus');
            if(nextStepButton.hasAttribute('disabled')){
                nextStepButton.removeAttribute('disabled');
                statusIndicator.innerText = '(Paused)';
            }else{
                nextStepButton.setAttribute('disabled', true);
                statusIndicator.innerText = '(Playing)';
            }
            app.ports.toggleLive.send("");
        });
        // next generation -- END

        // patterns -- START
        
        var brushRadios = document.querySelectorAll('input[type=radio][name="brush"]');

        var brushChangeHandler = function(event) {
            console.log("radio", this.value);
            app.ports.ship.send(this.value);
        }

        Array.prototype.forEach.call(brushRadios, function(radio) {
            radio.addEventListener('change', brushChangeHandler);
        });
        
        // patterns -- END
        
        var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        app.ports.newCells.subscribe(function(newCells) {
            var osc = createOscillatorsForCoords(app, audioCtx, gridSize, newCells);
            startOscillators(audioCtx, osc, 0.2);
        });
    });

    var currentGain = 1;
    var currentBaseFreqMod = 1;

    function createOscillatorsForCoords(app, audioCtx, gridSize, coordsArray){
      var result = [];

      coordsArray.forEach(function(element, index, array){
        var stereoPanning = element[1];

        var baseFrequency = 55; // A 55 Hz
        var y = gridSize - element[0];
        var frequency = baseFrequency * y;

        //console.log({x : x, y:y, frequency : frequency, pan: stereoPanning})

        // create Oscillator node
        var oscillator = audioCtx.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.value = currentBaseFreqMod * frequency; // value in hertz

        var gain = audioCtx.createGain();
        gain.gain.value = currentGain;

        // add a stereo panner to move sound left or right
        var panNode = audioCtx.createStereoPanner();
        panNode.pan.value = stereoPanning;
        oscillator.connect(gain);
        gain.connect(panNode);

        panNode.connect(audioCtx.destination);

        var subscriber = function(scalings) {
          currentBaseFreqMod = Math.pow(2, scalings.x * 3);
          oscillator.frequency.value = currentBaseFreqMod * frequency;
          currentGain = scalings.y * scalings.y;
          gain.gain.value = currentGain;
        };

        app.ports.audio.subscribe(subscriber);

        oscillator.onended = function() {
          app.ports.audio.unsubscribe(subscriber);
        };

        result.push(oscillator);
      });

      return result;
    }

    function startOscillators(audioCtx, oscillators, noteDuration){
        oscillators.forEach(function(oscillator) {
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + noteDuration);
        });
    }

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
    </script>
</body>

</html>
