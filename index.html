<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <title>Cellular acoustics</title>
  <link href="assets/vendor/normalize.css" rel="stylesheet">
  <link href="assets/main.css" rel="stylesheet">
</head>

<body>
  <header>
    <h1>Cyto-Acoustics</h1>
  </header>
  <div class="container">
    <div class="col col1-3">
      <section class="tools">
        <button id="reset">Reset &orarr;</button>
        <button id="nextStep" onclick="javascript:alert('Not implemented...');">Next &#9731;</button>
      </section>
      <section>
        <textarea id="notesToPlay" cols="40" rows="15"></textarea>
        <br/>
        <button id="play">&#9658; Play</button>
        <button id="pause" style="display:none;">&#10074;&#10074; Pause</button>
      </section>
    </div>
    <div class="col col2-3">
      <div id="matrix" class="matrix">Loading ...</div>
    </div>
  </div>
  <script type="text/javascript" src="target/cyto-acoustics.js"></script>
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function(event) {

      var matrix = document.getElementById('matrix');
      // remove loading message
      matrix.innerHTML ='';
      var app = Elm.Cytoacoustics.embed(matrix);
      document.getElementById('reset').addEventListener("click", function() {
        app.ports.reset.send("");
      });
      
      var notes = [
          [0, 0],
          [3, 3],
          [15, 15],
      ];
      
      document.getElementById('notesToPlay').value = JSON.stringify(notes);
      
      // create web audio api context
      var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
         
      
      // music playback experiments
      document.getElementById('play').addEventListener("click", function() {
        document.getElementById('pause').style.display = 'inline';
        document.getElementById('play').style.display = 'none';
        
        var coords = JSON.parse( document.getElementById('notesToPlay').value );
        
        var oscillators = createOscillatorsForCoords(audioCtx, coords);
        oscillators.forEach(function(oscillator){
          oscillator.start();
        });

        
        document.getElementById('pause').addEventListener("click", function(e) {
          document.getElementById('play').style.display = 'inline';
          document.getElementById('pause').style.display = 'none';
          oscillators.forEach(function(oscillator){
            oscillator.stop();
          });
          
          // remove this handler
	        e.target.removeEventListener(e.type, arguments.callee);
        });
      });     
      
    });
    
    function createOscillatorsForCoords(audioCtx, coordsArray){
      var result = [];
      
      coordsArray.forEach(function(element, index, array){
        var baseFrequency = 440; // A 440 Hz
        var x = element[0];
        var y = element[1];
        var frequency = baseFrequency *  Math.pow(2, x / 12);
        console.log({x : x, y:y, frequency : frequency})
        // create Oscillator node
        var oscillator = audioCtx.createOscillator();
        oscillator.type = 'square';
        oscillator.frequency.value = frequency; // value in hertz
        oscillator.connect(audioCtx.destination);
        
        result.push(oscillator);
      });
      
      return result;
    }
      // var context = new AudioContext();

      // //defaults to A440Hz, sine wave
      // var src = context.createOscillator();

      // // Now let's create a modulator to turn beeps on and off
      // var mod = context.createOscillator();
      // mod.type="square";
      // mod.frequency.value = "2";  // Start at 2Hz

      // var gain = context.createGain();
      // var scaler = context.createGain();

      // src.connect(gain);
      // gain.connect(context.destination);

      // mod.connect(scaler); // Mod signal is [-1,1]
      // scaler.gain.value = 0.5; // we need it to be [-0.5,0.5]
      // gain.gain.value = 0.5; // then it's summed with 0.5, so [0,1]
      // scaler.connect(gain.gain);

      // //start it up
      // src.start(0);
      // mod.start(0);


      // app.ports.???.subscribe(function(???) {
      //   gainNode.gain.value = ???;
      //   oscillator.frequency.value = ???;
      //   oscillator.detune.value = ???;
      // });
  </script>
</body>

</html>